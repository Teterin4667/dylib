name: Compile iOS dylib

on: [push]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create menu.m
      run: |
        cat > menu.m << 'EOF'
        #include <objc/runtime.h>
        #include <UIKit/UIKit.h>
        
        @interface FloatingMenu : UIView
        @property (nonatomic, strong) UIButton *button;
        @property (nonatomic, strong) UILabel *label;
        @property (nonatomic, assign) CGPoint touchOffset;
        @end
        
        @implementation FloatingMenu
        
        - (instancetype)initWithFrame:(CGRect)frame {
            self = [super initWithFrame:frame];
            if (self) {
                self.backgroundColor = [UIColor colorWithRed:0.2 green:0.5 blue:0.9 alpha:0.9];
                self.layer.cornerRadius = 10;
                self.layer.borderWidth = 2;
                self.layer.borderColor = [UIColor whiteColor].CGColor;
                
                UILabel *title = [[UILabel alloc] initWithFrame:CGRectMake(10, 5, 100, 20)];
                title.text = @"Menu";
                title.textColor = [UIColor whiteColor];
                [self addSubview:title];
                
                _label = [[UILabel alloc] initWithFrame:CGRectMake(100, 30, 50, 30)];
                _label.text = @"0";
                _label.textColor = [UIColor whiteColor];
                [self addSubview:_label];
                
                _button = [UIButton buttonWithType:UIButtonTypeSystem];
                _button.frame = CGRectMake(10, 30, 80, 30);
                [_button setTitle:@"Click" forState:UIControlStateNormal];
                _button.backgroundColor = [UIColor whiteColor];
                [_button addTarget:self action:@selector(clicked) forControlEvents:UIControlEventTouchUpInside];
                [self addSubview:_button];
                
                UIButton *closeBtn = [UIButton buttonWithType:UIButtonTypeCustom];
                closeBtn.frame = CGRectMake(140, 5, 30, 20);
                [closeBtn setTitle:@"âœ•" forState:UIControlStateNormal];
                [closeBtn setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
                [closeBtn addTarget:self action:@selector(close) forControlEvents:UIControlEventTouchUpInside];
                [self addSubview:closeBtn];
            }
            return self;
        }
        
        - (void)clicked {
            int count = [self.label.text intValue] + 1;
            self.label.text = [NSString stringWithFormat:@"%d", count];
        }
        
        - (void)close {
            [self removeFromSuperview];
        }
        
        - (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event {
            UITouch *touch = [touches anyObject];
            CGPoint point = [touch locationInView:self.superview];
            self.touchOffset = CGPointMake(point.x - self.frame.origin.x, point.y - self.frame.origin.y);
        }
        
        - (void)touchesMoved:(NSSet *)touches withEvent:(UIEvent *)event {
            UITouch *touch = [touches anyObject];
            CGPoint point = [touch locationInView:self.superview];
            self.frame = CGRectMake(point.x - self.touchOffset.x, point.y - self.touchOffset.y, 
                                   self.frame.size.width, self.frame.size.height);
        }
        
        @end
        
        static void (*orig_viewDidAppear)(id, SEL, BOOL);
        
        static void hooked_viewDidAppear(id self, SEL _cmd, BOOL animated) {
            orig_viewDidAppear(self, _cmd, animated);
            
            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC), dispatch_get_main_queue(), ^{
                UIWindow *window = [UIApplication sharedApplication].keyWindow;
                
                BOOL exists = NO;
                for (UIView *v in window.subviews) {
                    if ([v isKindOfClass:[FloatingMenu class]]) {
                        exists = YES;
                        break;
                    }
                }
                
                if (!exists) {
                    FloatingMenu *menu = [[FloatingMenu alloc] initWithFrame:CGRectMake(50, 100, 180, 70)];
                    [window addSubview:menu];
                }
            });
        }
        
        __attribute__((constructor))
        static void init() {
            dispatch_async(dispatch_get_main_queue(), ^{
                Class class = [UIViewController class];
                Method original = class_getInstanceMethod(class, @selector(viewDidAppear:));
                orig_viewDidAppear = (void *)method_setImplementation(original, (IMP)hooked_viewDidAppear);
            });
        }
        EOF
    
    - name: Compile with Xcode
      run: |
        xcrun -sdk iphoneos clang -arch arm64 -fobjc-arc -dynamiclib \
          -framework UIKit \
          -framework Foundation \
          -framework CoreGraphics \
          -isysroot $(xcrun -sdk iphoneos --show-sdk-path) \
          menu.m \
          -o floatingmenu.dylib
    
    - name: Upload dylib
      uses: actions/upload-artifact@v4
      with:
        name: floatingmenu.dylib
        path: floatingmenu.dylib
