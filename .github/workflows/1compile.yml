name: Build ScreenStretch Dylib

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install Dependencies
      run: |
        brew install ldid
        
    - name: Compile Dylib
      run: |
        # Создаём исходный код
        cat > ScreenStretch.m << 'EOF'
        #import <UIKit/UIKit.h>
        #import <QuartzCore/QuartzCore.h>
        
        @interface ScreenStretch : NSObject
        @property (nonatomic, weak) UIView *targetView;
        @property (nonatomic, assign) BOOL isStretched;
        + (instancetype)shared;
        - (void)stretchView:(UIView *)view atPoint:(CGPoint)point;
        - (void)resetStretch;
        @end
        
        @implementation ScreenStretch {
            CADisplayLink *_displayLink;
            CGFloat _intensity;
            CGPoint _touchPoint;
        }
        
        + (instancetype)shared {
            static ScreenStretch *instance = nil;
            static dispatch_once_t onceToken;
            dispatch_once(&onceToken, ^{
                instance = [[ScreenStretch alloc] init];
            });
            return instance;
        }
        
        - (void)stretchView:(UIView *)view atPoint:(CGPoint)point {
            self.targetView = view;
            _touchPoint = point;
            _intensity = 0.8;
            self.isStretched = YES;
            
            if (!_displayLink) {
                _displayLink = [CADisplayLink displayLinkWithTarget:self selector:@selector(updateStretch)];
                [_displayLink addToRunLoop:[NSRunLoop mainRunLoop] forMode:NSRunLoopCommonModes];
            }
            
            [self applyStretch];
        }
        
        - (void)applyStretch {
            CATransform3D transform = CATransform3DIdentity;
            transform.m34 = -1.0 / 500.0;
            
            CGFloat stretch = 1.0 + (_intensity * 0.3);
            CGFloat offsetX = (_touchPoint.x - self.targetView.bounds.size.width/2) * _intensity * 0.2;
            CGFloat offsetY = (_touchPoint.y - self.targetView.bounds.size.height/2) * _intensity * 0.2;
            
            transform = CATransform3DTranslate(transform, offsetX, offsetY, 0);
            transform = CATransform3DScale(transform, stretch, stretch, 1);
            
            self.targetView.layer.transform = transform;
        }
        
        - (void)updateStretch {
            _intensity *= 0.95;
            [self applyStretch];
            
            if (_intensity < 0.01) {
                [self resetStretch];
            }
        }
        
        - (void)resetStretch {
            [_displayLink invalidate];
            _displayLink = nil;
            self.isStretched = NO;
            
            [UIView animateWithDuration:0.3 animations:^{
                self.targetView.layer.transform = CATransform3DIdentity;
            }];
        }
        
        @end
        
        // Экспортируемые функции для C
        extern "C" {
            void ScreenStretchApply(UIView *view, CGFloat x, CGFloat y) {
                [[ScreenStretch shared] stretchView:view atPoint:CGPointMake(x, y)];
            }
            
            void ScreenStretchReset(void) {
                [[ScreenStretch shared] resetStretch];
            }
            
            BOOL ScreenStretchIsActive(void) {
                return [ScreenStretch shared].isStretched;
            }
        }
        EOF
        
        cat > ScreenStretch.h << 'EOF'
        #import <UIKit/UIKit.h>
        
        @interface ScreenStretch : NSObject
        @property (nonatomic, readonly) BOOL isStretched;
        + (instancetype)shared;
        - (void)stretchView:(UIView *)view atPoint:(CGPoint)point;
        - (void)resetStretch;
        @end
        
        #ifdef __cplusplus
        extern "C" {
        #endif
        void ScreenStretchApply(UIView *view, CGFloat x, CGFloat y);
        void ScreenStretchReset(void);
        BOOL ScreenStretchIsActive(void);
        #ifdef __cplusplus
        }
        #endif
        EOF
        
        # Компилируем для ARM64 (iOS устройства)
        clang -arch arm64 \
              -isysroot $(xcrun --sdk iphoneos --show-sdk-path) \
              -dynamiclib \
              -miphoneos-version-min=12.0 \
              -fobjc-arc \
              -framework Foundation \
              -framework UIKit \
              -framework QuartzCore \
              -o ScreenStretch.dylib \
              ScreenStretch.m \
              -install_name @rpath/ScreenStretch.dylib
        
        # Компилируем для симулятора (x86_64)
        clang -arch x86_64 \
              -isysroot $(xcrun --sdk iphonesimulator --show-sdk-path) \
              -dynamiclib \
              -mios-simulator-version-min=12.0 \
              -fobjc-arc \
              -framework Foundation \
              -framework UIKit \
              -framework QuartzCore \
              -o ScreenStretch_sim.dylib \
              ScreenStretch.m
        
        # Создаём универсальный бинарник
        lipo -create -output ScreenStretch_universal.dylib \
             -arch arm64 ScreenStretch.dylib \
             -arch x86_64 ScreenStretch_sim.dylib
        
        # Подписываем
        ldid -S ScreenStretch.dylib
        ldid -S ScreenStretch_universal.dylib
        
        # Создаём структуру фреймворка
        mkdir -p ScreenStretch.framework/Headers
        cp ScreenStretch_universal.dylib ScreenStretch.framework/ScreenStretch
        cp ScreenStretch.h ScreenStretch.framework/Headers/
        
        # Создаём Info.plist
        cat > ScreenStretch.framework/Info.plist << PLIST
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>en</string>
            <key>CFBundleExecutable</key>
            <string>ScreenStretch</string>
            <key>CFBundleIdentifier</key>
            <string>com.example.screenstretch</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>ScreenStretch</string>
            <key>CFBundlePackageType</key>
            <string>FMWK</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>MinimumOSVersion</key>
            <string>12.0</string>
        </dict>
        </plist>
        PLIST
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ScreenStretch-iOS
        path: |
          ScreenStretch.dylib
          ScreenStretch_universal.dylib
          ScreenStretch.framework/
          ScreenStretch.h
          
    - name: Create Example Project
      run: |
        cat > README.md << 'EOF'
        # ScreenStretch Dylib
        
        Библиотека для эффекта растяжения экрана в iOS приложениях.
        
        ## Установка
        
        ### CocoaPods
        ```ruby
        pod 'ScreenStretch', :path => 'ScreenStretch.podspec'
        ```
        
        ### Ручная установка
        1. Скачайте ScreenStretch.framework
        2. Добавьте в Xcode проект
        3. В Build Settings -> Other Linker Flags добавьте `-ObjC`
        
        ## Использование
        
        ```objc
        #import <ScreenStretch/ScreenStretch.h>
        
        // Objective-C
        - (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event {
            CGPoint point = [touches.anyObject locationInView:self.view];
            [[ScreenStretch shared] stretchView:self.view atPoint:point];
        }
        
        - (void)touchesEnded:(NSSet *)touches withEvent:(UIEvent *)event {
            [[ScreenStretch shared] resetStretch];
        }
        
        // Или через C функции
        - (void)touchesMoved:(NSSet *)touches withEvent:(UIEvent *)event {
            CGPoint point = [touches.anyObject locationInView:self.view];
            ScreenStretchApply(self.view, point.x, point.y);
        }
        ```
        
        ## Swift
        
        ```swift
        import ScreenStretch
        
        override func touchesBegan(_ touches: Set<UITouch>, with event: UIEvent?) {
            guard let point = touches.first?.location(in: view) else { return }
            ScreenStretch.shared().stretchView(view, at: point)
        }
        
        override func touchesEnded(_ touches: Set<UITouch>, with event: UIEvent?) {
            ScreenStretch.shared().resetStretch()
        }
        ```
        
        ## API
        
        - `stretchView:atPoint:` - применить растяжение
        - `resetStretch` - сбросить эффект
        - `isStretched` - проверка состояния
        EOF
        
        # Создаём podspec
        cat > ScreenStretch.podspec << EOF
        Pod::Spec.new do |s|
          s.name             = 'ScreenStretch'
          s.version          = '1.0.0'
          s.summary          = 'Screen stretch effect library'
          s.description      = 'Library for applying stretch effect to views'
          s.homepage         = 'https://github.com/yourname/screenstretch'
          s.license          = { :type => 'MIT' }
          s.author           = { 'Your Name' => 'email@example.com' }
          s.source           = { :path => '.' }
          s.ios.deployment_target = '12.0'
          s.vendored_frameworks = 'ScreenStretch.framework'
        end
        EOF
        
    - name: Upload Documentation
      uses: actions/upload-artifact@v4
      with:
        name: Documentation
        path: |
          README.md
          ScreenStretch.podspec
          
    - name: Create Release Package
      run: |
        zip -r ScreenStretch.zip ScreenStretch.framework ScreenStretch.h README.md
        zip -r ScreenStretch-Binary.zip ScreenStretch.dylib ScreenStretch_universal.dylib
        
    - name: Upload Release
      uses: actions/upload-artifact@v4
      with:
        name: Release-Package
        path: |
          ScreenStretch.zip
          ScreenStretch-Binary.zip
