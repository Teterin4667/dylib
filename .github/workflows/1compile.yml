name: Build ScreenStretch Dylib

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install Dependencies
      run: |
        brew install ldid
        
    - name: Compile Dylib
      run: |
        # Создаём исходный код (исправленная версия)
        cat > ScreenStretch.m << 'EOF'
        #import <UIKit/UIKit.h>
        #import <QuartzCore/QuartzCore.h>
        #import <Foundation/Foundation.h>
        
        @interface ScreenStretch : NSObject
        @property (nonatomic, weak) UIView *targetView;
        @property (nonatomic, assign) BOOL isStretched;
        + (instancetype)shared;
        - (void)stretchView:(UIView *)view atPoint:(CGPoint)point;
        - (void)resetStretch;
        @end
        
        @implementation ScreenStretch {
            CADisplayLink *_displayLink;
            CGFloat _intensity;
            CGPoint _touchPoint;
        }
        
        + (instancetype)shared {
            static ScreenStretch *instance = nil;
            static dispatch_once_t onceToken;
            dispatch_once(&onceToken, ^{
                instance = [[ScreenStretch alloc] init];
            });
            return instance;
        }
        
        - (instancetype)init {
            self = [super init];
            if (self) {
                _isStretched = NO;
                _intensity = 0.0;
            }
            return self;
        }
        
        - (void)stretchView:(UIView *)view atPoint:(CGPoint)point {
            self.targetView = view;
            _touchPoint = point;
            _intensity = 0.8;
            self.isStretched = YES;
            
            if (!_displayLink) {
                _displayLink = [CADisplayLink displayLinkWithTarget:self selector:@selector(updateStretch)];
                [_displayLink addToRunLoop:[NSRunLoop mainRunLoop] forMode:NSRunLoopCommonModes];
            }
            
            [self applyStretch];
        }
        
        - (void)applyStretch {
            if (!self.targetView) return;
            
            CATransform3D transform = CATransform3DIdentity;
            transform.m34 = -1.0 / 500.0;
            
            CGFloat stretch = 1.0 + (_intensity * 0.3);
            CGFloat offsetX = (_touchPoint.x - self.targetView.bounds.size.width/2) * _intensity * 0.2;
            CGFloat offsetY = (_touchPoint.y - self.targetView.bounds.size.height/2) * _intensity * 0.2;
            
            transform = CATransform3DTranslate(transform, offsetX, offsetY, 0);
            transform = CATransform3DScale(transform, stretch, stretch, 1);
            
            self.targetView.layer.transform = transform;
        }
        
        - (void)updateStretch {
            _intensity *= 0.95;
            [self applyStretch];
            
            if (_intensity < 0.01) {
                [self resetStretch];
            }
        }
        
        - (void)resetStretch {
            [_displayLink invalidate];
            _displayLink = nil;
            self.isStretched = NO;
            
            [UIView animateWithDuration:0.3 animations:^{
                self.targetView.layer.transform = CATransform3DIdentity;
            }];
        }
        
        @end
        
        // C функции для экспорта (исправлено - убрал extern "C" в .m файле)
        void ScreenStretchApply(UIView *view, CGFloat x, CGFloat y) {
            [[ScreenStretch shared] stretchView:view atPoint:CGPointMake(x, y)];
        }
        
        void ScreenStretchReset(void) {
            [[ScreenStretch shared] resetStretch];
        }
        
        BOOL ScreenStretchIsActive(void) {
            return [ScreenStretch shared].isStretched;
        }
        EOF
        
        cat > ScreenStretch.h << 'EOF'
        #import <UIKit/UIKit.h>
        
        @interface ScreenStretch : NSObject
        @property (nonatomic, readonly) BOOL isStretched;
        + (instancetype)shared;
        - (void)stretchView:(UIView *)view atPoint:(CGPoint)point;
        - (void)resetStretch;
        @end
        
        #ifdef __cplusplus
        extern "C" {
        #endif
        void ScreenStretchApply(UIView *view, CGFloat x, CGFloat y);
        void ScreenStretchReset(void);
        BOOL ScreenStretchIsActive(void);
        #ifdef __cplusplus
        }
        #endif
        EOF
        
        # Создаём module.modulemap
        cat > module.modulemap << 'EOF'
        framework module ScreenStretch {
            umbrella header "ScreenStretch.h"
            export *
            module * { export * }
        }
        EOF
        
        # Компилируем для ARM64 (iOS устройства)
        clang -arch arm64 \
              -isysroot $(xcrun --sdk iphoneos --show-sdk-path) \
              -dynamiclib \
              -miphoneos-version-min=12.0 \
              -fobjc-arc \
              -framework Foundation \
              -framework UIKit \
              -framework QuartzCore \
              -o ScreenStretch.dylib \
              ScreenStretch.m \
              -install_name @rpath/ScreenStretch.dylib
        
        # Компилируем для симулятора (x86_64)
        clang -arch x86_64 \
              -isysroot $(xcrun --sdk iphonesimulator --show-sdk-path) \
              -dynamiclib \
              -mios-simulator-version-min=12.0 \
              -fobjc-arc \
              -framework Foundation \
              -framework UIKit \
              -framework QuartzCore \
              -o ScreenStretch_sim.dylib \
              ScreenStretch.m
        
        # Проверяем что файлы создались
        ls -la *.dylib
        
        # Создаём универсальный бинарник если есть оба файла
        if [ -f "ScreenStretch.dylib" ] && [ -f "ScreenStretch_sim.dylib" ]; then
            lipo -create -output ScreenStretch_universal.dylib \
                 -arch arm64 ScreenStretch.dylib \
                 -arch x86_64 ScreenStretch_sim.dylib
        else
            echo "One of the dylib files is missing, skipping universal binary"
            cp ScreenStretch.dylib ScreenStretch_universal.dylib
        fi
        
        # Подписываем
        ldid -S ScreenStretch.dylib 2>/dev/null || true
        ldid -S ScreenStretch_universal.dylib 2>/dev/null || true
        
        # Создаём структуру фреймворка
        mkdir -p ScreenStretch.framework/Headers
        mkdir -p ScreenStretch.framework/Modules
        cp ScreenStretch_universal.dylib ScreenStretch.framework/ScreenStretch
        cp ScreenStretch.h ScreenStretch.framework/Headers/
        cp module.modulemap ScreenStretch.framework/Modules/
        
        # Создаём Info.plist
        cat > ScreenStretch.framework/Info.plist << 'PLIST'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>en</string>
            <key>CFBundleExecutable</key>
            <string>ScreenStretch</string>
            <key>CFBundleIdentifier</key>
            <string>com.screenstretch.dylib</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>ScreenStretch</string>
            <key>CFBundlePackageType</key>
            <string>FMWK</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>MinimumOSVersion</key>
            <string>12.0</string>
        </dict>
        </plist>
        PLIST
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ScreenStretch-iOS
        path: |
          ScreenStretch.dylib
          ScreenStretch_universal.dylib
          ScreenStretch.framework/
          ScreenStretch.h
          
    - name: Create Documentation
      run: |
        cat > README.md << 'EOF'
        # ScreenStretch Dylib
        
        Библиотека для эффекта растяжения экрана в iOS приложениях.
        
        ## Установка
        
        ### Ручная установка
        1. Скачайте ScreenStretch.framework из артефактов
        2. Добавьте в Xcode проект (Drag & drop)
        3. В Build Settings -> Other Linker Flags добавьте `-ObjC`
        4. В General -> Frameworks добавьте ScreenStretch.framework
        
        ## Использование
        
        ### Objective-C
        ```objc
        #import <ScreenStretch/ScreenStretch.h>
        
        - (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event {
            CGPoint point = [touches.anyObject locationInView:self.view];
            [[ScreenStretch shared] stretchView:self.view atPoint:point];
        }
        
        - (void)touchesEnded:(NSSet *)touches withEvent:(UIEvent *)event {
            [[ScreenStretch shared] resetStretch];
        }
        ```
        
        ### Swift
        ```swift
        import ScreenStretch
        
        override func touchesBegan(_ touches: Set<UITouch>, with event: UIEvent?) {
            guard let point = touches.first?.location(in: view) else { return }
            ScreenStretch.shared().stretchView(view, at: point)
        }
        
        override func touchesEnded(_ touches: Set<UITouch>, with event: UIEvent?) {
            ScreenStretch.shared().resetStretch()
        }
        ```
        
        ### C API
        ```c
        #import <ScreenStretch/ScreenStretch.h>
        
        void handleTouch(UIView *view, float x, float y) {
            ScreenStretchApply(view, x, y);
        }
        ```
        
        ## API Reference
        
        - `+shared` - Получить синглтон
        - `-stretchView:atPoint:` - Применить растяжение к view в точке
        - `-resetStretch` - Сбросить эффект
        - `isStretched` - Проверить активен ли эффект
        
        ## Требования
        
        - iOS 12.0+
        - ARC
        - Xcode 12+
        
        ## Лицензия
        
        MIT
        EOF
        
    - name: Upload Documentation
      uses: actions/upload-artifact@v4
      with:
        name: Documentation
        path: README.md
        
    - name: Create Release Package
      run: |
        zip -r ScreenStretch.zip ScreenStretch.framework ScreenStretch.h README.md
        zip -r ScreenStretch-Binaries.zip ScreenStretch.dylib ScreenStretch_universal.dylib
        
    - name: Upload Release Package
      uses: actions/upload-artifact@v4
      with:
        name: Release-Packages
        path: |
          ScreenStretch.zip
          ScreenStretch-Binaries.zip
