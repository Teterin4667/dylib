name: Build iOS Dylib

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup iOS SDK
      run: |
        xcodebuild -version
        xcrun --sdk iphoneos --show-sdk-path
        
    - name: Build Dylib for iOS
      run: |
        # ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ Ð´Ð»Ñ iOS arm64
        clang++ -std=c++11 -dynamiclib \
          -arch arm64 \
          -isysroot $(xcrun --sdk iphoneos --show-sdk-path) \
          -miphoneos-version-min=12.0 \
          -framework Foundation \
          -framework UIKit \
          -framework CoreGraphics \
          -o game_helper.dylib \
          main.mm \
          -Wall -O2 \
          -current_version 1.0 \
          -compatibility_version 1.0
          
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñ‹
        lipo -info game_helper.dylib
        
    - name: Create Release Package
      run: |
        mkdir -p release
        cp game_helper.dylib release/
        
        # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ README
        cat > release/README.md << 'EOF'
        # ðŸŽ® Game Helper Ð´Ð»Ñ iOS

        ## Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸:
        - âœ… ÐÐ²Ñ‚Ð¾ÐºÐ»Ð¸ÐºÐµÑ€
        - âœ… Ð Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° FPS
        - âœ… ÐšÐ°Ñ€Ñ‚Ð¾Ñ„ÐµÐ»ÑŒÐ½Ð°Ñ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°
        - âœ… Ð¡Ñ‡ÐµÑ‚Ñ‡Ð¸Ðº FPS
        - âœ… Ð£ÑÐ¸Ð»ÐµÐ½Ð¸Ðµ ÑÑ€ÐºÐ¾ÑÑ‚Ð¸
        - âœ… Ð ÐµÐ¶Ð¸Ð¼ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ
        - âœ… ÐÐ¾Ñ‡Ð½Ð¾Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼
        - âœ… Ð­Ð½ÐµÑ€Ð³Ð¾ÑÐ±ÐµÑ€ÐµÐ¶ÐµÐ½Ð¸Ðµ
        - âœ… Ð£ÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ðµ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸Ð¹
        - âœ… Ð—ÑƒÐ¼ ÑÐºÑ€Ð°Ð½Ð°
        - âœ… Ð Ð°ÑÑ‚ÑÐ¶ÐµÐ½Ð¸Ðµ ÑÐºÑ€Ð°Ð½Ð° (pinch-Ð¶ÐµÑÑ‚Ð°Ð¼Ð¸)
        - âœ… Ð¨Ð¸Ñ€Ð¾ÐºÐ¾Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼

        ## ÐÐ¾Ð²Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ: Ð Ð°ÑÑ‚ÑÐ¶ÐµÐ½Ð¸Ðµ ÑÐºÑ€Ð°Ð½Ð°
        - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð´Ð²Ð° Ð¿Ð°Ð»ÑŒÑ†Ð° (pinch Ð¶ÐµÑÑ‚) Ð´Ð»Ñ Ñ€Ð°ÑÑ‚ÑÐ¶ÐµÐ½Ð¸Ñ ÑÐºÑ€Ð°Ð½Ð°
        - ÐšÐ½Ð¾Ð¿ÐºÐ° "Ð¡Ð±Ñ€Ð¾Ñ" Ð´Ð»Ñ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð° Ðº Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¼Ñƒ Ñ€ÐµÐ¶Ð¸Ð¼Ñƒ
        - Ð˜Ð´ÐµÐ°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð²Ð¸Ð´ÐµÐ¾ Ð¸ Ð¸Ð³Ñ€

        ## Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:
        - ÐŸÐ»Ð°Ð²Ð°ÑŽÑ‰Ð°Ñ ÐºÐ½Ð¾Ð¿ÐºÐ° âš™ï¸ Ð´Ð»Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¼ÐµÐ½ÑŽ
        - ÐœÐ¾Ð¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÑ‚Ð°ÑÐºÐ¸Ð²Ð°Ñ‚ÑŒ Ð² Ð»ÑŽÐ±Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾
        - ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð´Ð»Ñ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ/Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
        - Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð²Ð½Ð¸Ð·Ñƒ ÑÐºÑ€Ð°Ð½Ð°

        ## Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:
        1. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ game_helper.dylib Ð² Ð²Ð°Ñˆ Ð¿Ñ€Ð¾ÐµÐºÑ‚ iOS
        2. Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ dlopen():
        ```objc
        void *handle = dlopen("path/to/game_helper.dylib", RTLD_LAZY);
        ```
        3. Ð˜Ð»Ð¸ Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð² Linked Frameworks and Libraries

        ## Ð¡Ð¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ:
        - iOS 12.0 Ð¸ Ð²Ñ‹ÑˆÐµ
        - arm64 Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°
        - ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‚ÑÑ Ð²ÑÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
        EOF
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: game-helper-ios
        path: release/
        retention-days: 90
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/game_helper.dylib
          release/README.md
        generate_release_notes: true
        prerelease: false
